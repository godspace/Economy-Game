<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–≤–æ–ª—é—Ü–∏—è –î–æ–≤–µ—Ä–∏—è - –®–∫–æ–ª—å–Ω–∞—è –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –ò–≥—Ä–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-pane { padding: 20px 0; }
        .deal-card { 
            transition: transform 0.2s; 
            margin-bottom: 15px;
        }
        .deal-card:hover { transform: translateY(-2px); }
        .reputation-good { color: #28a745; }
        .reputation-medium { color: #ffc107; }
        .reputation-bad { color: #dc3545; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .nav-tabs .nav-link.active { font-weight: bold; }
        .decision-btn { margin: 5px; }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
    <div class="modal fade" id="loginModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–í—Ö–æ–¥ –≤ –∏–≥—Ä—É "–≠–≤–æ–ª—é—Ü–∏—è –î–æ–≤–µ—Ä–∏—è"</h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">–ù–∏–∫–Ω–µ–π–º</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö–ª–∞—Å—Å</label>
                            <select class="form-select" id="class" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
                                <option value="5–ê">5–ê</option>
                                <option value="5–ë">5–ë</option>
                                <option value="5–í">5–í</option>
                                <option value="5–ì">5–ì</option>
                                <option value="6–ê">6–ê</option>
                                <option value="6–ë">6–ë</option>
                                <option value="6–í">6–í</option>
                                <option value="6–ì">6–ì</option>
                                <option value="6–î">6–î</option>
                                <option value="7–ê">7–ê</option>
                                <option value="7–ë">7–ë</option>
                                <option value="8–ê">8–ê</option>
                                <option value="8–ë">8–ë</option>
                                <option value="8–í">8–í</option>
                                <option value="9–ê">9–ê</option>
                                <option value="9–ë">9–ë</option>
                                <option value="9–í">9–í</option>
                                <option value="10–ê">10–ê</option>
                                <option value="10–ë">10–ë</option>
                                <option value="11">11</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="loginOrRegister()">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–≥—Ä—ã -->
    <div id="gameInterface" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <span class="navbar-brand">–≠–≤–æ–ª—é—Ü–∏—è –î–æ–≤–µ—Ä–∏—è</span>
                <div class="navbar-nav ms-auto">
                    <span class="navbar-text" id="playerInfo"></span>
                </div>
            </div>
        </nav>

        <div class="container mt-3">
            <ul class="nav nav-tabs" id="gameTabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#profile" data-bs-toggle="tab">
                        <i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#trade" data-bs-toggle="tab">
                        <i class="fas fa-handshake"></i> –¢–æ—Ä–≥–æ–≤–ª—è
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#ranking" data-bs-toggle="tab">
                        <i class="fas fa-trophy"></i> –†–µ–π—Ç–∏–Ω–≥
                    </a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
                <div class="tab-pane fade show active" id="profile">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card stats-card">
                                <div class="card-body text-center">
                                    <h3 id="playerCoins">100</h3>
                                    <p>–ú–æ–Ω–µ—Ç—ã</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 id="playerReputation">100</h3>
                                    <p>–†–µ–ø—É—Ç–∞—Ü–∏—è</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3 id="playerDealsCompleted">0</h3>
                                    <p>–°–¥–µ–ª–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h5>
                        <div id="dealHistory" class="list-group"></div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ -->
                <div class="tab-pane fade" id="trade">
                    <div class="d-flex justify-content-between mb-3">
                        <h5>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–¥–µ–ª–∫–∏</h5>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDealModal">
                            <i class="fas fa-plus"></i> –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–¥–µ–ª–∫—É
                        </button>
                    </div>
                    
                    <div id="availableDeals"></div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
                <div class="tab-pane fade" id="ranking">
                    <h5>–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>–ú–µ—Å—Ç–æ</th>
                                    <th>–ò–≥—Ä–æ–∫</th>
                                    <th>–ö–ª–∞—Å—Å</th>
                                    <th>–ú–æ–Ω–µ—Ç—ã</th>
                                    <th>–†–µ–ø—É—Ç–∞—Ü–∏—è</th>
                                    <th>–°–¥–µ–ª–æ–∫</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ -->
    <div class="modal fade" id="createDealModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–¥–µ–ª–∫—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createDealForm">
                        <div class="mb-3">
                            <label class="form-label">–°—É–º–º–∞ —Å–¥–µ–ª–∫–∏</label>
                            <input type="number" class="form-control" id="dealAmount" min="10" max="1000" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ</label>
                            <div>
                                <button type="button" class="btn btn-outline-success decision-btn" onclick="setDecision('cooperate')">
                                    <i class="fas fa-handshake"></i> –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å
                                </button>
                                <button type="button" class="btn btn-outline-danger decision-btn" onclick="setDecision('cheat')">
                                    <i class="fas fa-user-slash"></i> –û–±–º–∞–Ω—É—Ç—å
                                </button>
                            </div>
                            <input type="hidden" id="playerDecision" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="createDeal()">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–¥–µ–ª–∫–∏ -->
    <div class="modal fade" id="acceptDealModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ü—Ä–∏–Ω—è—Ç—å —Å–¥–µ–ª–∫—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç: <strong id="dealFromPlayer"></strong></p>
                    <p>–†–µ–ø—É—Ç–∞—Ü–∏—è: <span id="dealReputation"></span></p>
                    <p>–°—É–º–º–∞: <strong id="dealSum"></strong> –º–æ–Ω–µ—Ç</p>
                    
                    <div class="mb-3">
                        <label class="form-label">–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                        <div>
                            <button type="button" class="btn btn-outline-success decision-btn" onclick="setAcceptDecision('cooperate')">
                                <i class="fas fa-handshake"></i> –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å
                            </button>
                            <button type="button" class="btn btn-outline-danger decision-btn" onclick="setAcceptDecision('cheat')">
                                <i class="fas fa-user-slash"></i> –û–±–º–∞–Ω—É—Ç—å
                            </button>
                        </div>
                        <input type="hidden" id="acceptDecision">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="acceptDeal()">–ó–∞–∫–ª—é—á–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–¥–µ–ª–∫–∏ -->
    <div class="modal fade" id="dealResultModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–¥–µ–ª–∫–∏</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="dealResultContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">–ü–æ–Ω—è—Ç–Ω–æ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        const supabaseUrl = 'https://isugrtihjmbrzwflybrr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzdWdydGloam1icnp3Zmx5YnJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODQ0OTQsImV4cCI6MjA3ODk2MDQ5NH0.ek79k1g5svlLdhbYS664Lkc-6_tKc06qUgR-MhZtGNI';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentPlayer = null;
        let currentDealId = null;

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        });

        // –í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function loginOrRegister() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const playerClass = document.getElementById('class').value;

            if (!username || !password || !playerClass) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
            const { data: existingPlayer, error: checkError } = await supabase
                .from('players')
                .select('*')
                .eq('username', username)
                .single();

            if (checkError && checkError.code !== 'PGRST116') {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + checkError.message);
                return;
            }

            if (existingPlayer) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
                if (existingPlayer.password !== password) {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                    return;
                }
                currentPlayer = existingPlayer;
            } else {
                // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                const { data: newPlayer, error: insertError } = await supabase
                    .from('players')
                    .insert([{ username, password, class: playerClass }])
                    .select()
                    .single();

                if (insertError) {
                    alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + insertError.message);
                    return;
                }
                currentPlayer = newPlayer;
            }

            // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            document.getElementById('gameInterface').style.display = 'block';
            updatePlayerInfo();
            loadAvailableDeals();
            loadRanking();
            loadDealHistory();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
        function updatePlayerInfo() {
            document.getElementById('playerInfo').textContent = 
                `${currentPlayer.username} (${currentPlayer.class})`;
            document.getElementById('playerCoins').textContent = currentPlayer.coins;
            document.getElementById('playerReputation').textContent = currentPlayer.reputation;
            document.getElementById('playerDealsCompleted').textContent = currentPlayer.deals_completed;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
        async function loadAvailableDeals() {
            const { data: deals, error } = await supabase
                .from('deals')
                .select(`
                    *,
                    from_player:players!deals_from_player_id_fkey(username, reputation, class)
                `)
                .eq('status', 'pending')
                .neq('from_player_id', currentPlayer.id);

            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫:', error);
                return;
            }

            const dealsContainer = document.getElementById('availableDeals');
            dealsContainer.innerHTML = '';

            if (deals.length === 0) {
                dealsContainer.innerHTML = '<div class="alert alert-info">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>';
                return;
            }

            deals.forEach(deal => {
                const reputationClass = deal.from_player.reputation >= 80 ? 'reputation-good' : 
                                      deal.from_player.reputation >= 50 ? 'reputation-medium' : 'reputation-bad';
                
                const dealCard = document.createElement('div');
                dealCard.className = 'card deal-card';
                dealCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">–°–¥–µ–ª–∫–∞ –Ω–∞ ${deal.amount} –º–æ–Ω–µ—Ç</h5>
                        <p class="card-text">
                            –û—Ç: ${deal.from_player.username} (${deal.from_player.class})<br>
                            –†–µ–ø—É—Ç–∞—Ü–∏—è: <span class="${reputationClass}">${deal.from_player.reputation}</span>
                        </p>
                        <button class="btn btn-primary" onclick="openAcceptDealModal('${deal.id}')">
                            –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–¥–µ–ª–∫—É
                        </button>
                    </div>
                `;
                dealsContainer.appendChild(dealCard);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
        async function loadRanking() {
            const { data: players, error } = await supabase
                .from('players')
                .select('*')
                .order('coins', { ascending: false });

            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', error);
                return;
            }

            const rankingTable = document.getElementById('rankingTable');
            rankingTable.innerHTML = '';

            players.forEach((player, index) => {
                const row = document.createElement('tr');
                if (player.id === currentPlayer.id) {
                    row.className = 'table-primary';
                }
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.username}</td>
                    <td>${player.class}</td>
                    <td>${player.coins}</td>
                    <td>${player.reputation}</td>
                    <td>${player.deals_completed}</td>
                `;
                rankingTable.appendChild(row);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫
        async function loadDealHistory() {
            const { data: history, error } = await supabase
                .from('deal_history')
                .select(`
                    *,
                    player1:players!deal_history_player1_id_fkey(username),
                    player2:players!deal_history_player2_id_fkey(username)
                `)
                .or(`player1_id.eq.${currentPlayer.id},player2_id.eq.${currentPlayer.id}`)
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                return;
            }

            const historyContainer = document.getElementById('dealHistory');
            historyContainer.innerHTML = '';

            history.forEach(record => {
                const isPlayer1 = record.player1_id === currentPlayer.id;
                const otherPlayer = isPlayer1 ? record.player2 : record.player1;
                const myDecision = isPlayer1 ? record.player1_decision : record.player2_decision;
                const otherDecision = isPlayer1 ? record.player2_decision : record.player1_decision;
                
                const historyItem = document.createElement('div');
                historyItem.className = 'list-group-item';
                historyItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">–°–¥–µ–ª–∫–∞ —Å ${otherPlayer.username}</h6>
                        <small>${new Date(record.created_at).toLocaleDateString()}</small>
                    </div>
                    <p class="mb-1">
                        –í—ã: ${myDecision === 'cooperate' ? 'ü§ù –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞–ª–∏' : 'üíî –û–±–º–∞–Ω—É–ª–∏'} | 
                        ${otherPlayer.username}: ${otherDecision === 'cooperate' ? 'ü§ù –°–æ—Ç—Ä—É–¥–Ω–∏—á–∞–ª' : 'üíî –û–±–º–∞–Ω—É–ª'}
                    </p>
                    <small>–ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${isPlayer1 ? record.player1_coins_change : record.player2_coins_change} –º–æ–Ω–µ—Ç, 
                    —Ä–µ–ø—É—Ç–∞—Ü–∏—è ${isPlayer1 ? record.player1_reputation_change : record.player2_reputation_change}</small>
                `;
                historyContainer.appendChild(historyItem);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
        function setDecision(decision) {
            document.getElementById('playerDecision').value = decision;
            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.decision-btn').forEach(btn => {
                btn.classList.remove('btn-success', 'btn-danger');
                btn.classList.add('btn-outline-success', 'btn-outline-danger');
            });
            event.target.classList.remove('btn-outline-success', 'btn-outline-danger');
            event.target.classList.add(decision === 'cooperate' ? 'btn-success' : 'btn-danger');
        }

        async function createDeal() {
            const amount = parseInt(document.getElementById('dealAmount').value);
            const decision = document.getElementById('playerDecision').value;

            if (!amount || amount < 10 || amount > currentPlayer.coins) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Å–¥–µ–ª–∫–∏ (–º–∏–Ω. 10, –º–∞–∫—Å. –≤–∞—à–∏ –º–æ–Ω–µ—Ç—ã)');
                return;
            }

            if (!decision) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ!');
                return;
            }

            const { error } = await supabase
                .from('deals')
                .insert([{
                    from_player_id: currentPlayer.id,
                    amount: amount,
                    from_decision: decision
                }]);

            if (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏: ' + error.message);
                return;
            }

            bootstrap.Modal.getInstance(document.getElementById('createDealModal')).hide();
            document.getElementById('createDealForm').reset();
            loadAvailableDeals();
            alert('–°–¥–µ–ª–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∞!');
        }

        // –ü—Ä–∏–Ω—è—Ç–∏–µ —Å–¥–µ–ª–∫–∏
        let currentDeal = null;

        async function openAcceptDealModal(dealId) {
            const { data: deal, error } = await supabase
                .from('deals')
                .select(`
                    *,
                    from_player:players!deals_from_player_id_fkey(username, reputation)
                `)
                .eq('id', dealId)
                .single();

            if (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–∫–∏: ' + error.message);
                return;
            }

            currentDeal = deal;
            currentDealId = dealId;

            document.getElementById('dealFromPlayer').textContent = 
                `${deal.from_player.username} (—Ä–µ–ø—É—Ç–∞—Ü–∏—è: ${deal.from_player.reputation})`;
            document.getElementById('dealReputation').textContent = deal.from_player.reputation;
            document.getElementById('dealReputation').className = 
                deal.from_player.reputation >= 80 ? 'reputation-good' : 
                deal.from_player.reputation >= 50 ? 'reputation-medium' : 'reputation-bad';
            document.getElementById('dealSum').textContent = deal.amount;

            new bootstrap.Modal(document.getElementById('acceptDealModal')).show();
        }

        function setAcceptDecision(decision) {
            document.getElementById('acceptDecision').value = decision;
            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('#acceptDealModal .decision-btn').forEach(btn => {
                btn.classList.remove('btn-success', 'btn-danger');
                btn.classList.add('btn-outline-success', 'btn-outline-danger');
            });
            event.target.classList.remove('btn-outline-success', 'btn-outline-danger');
            event.target.classList.add(decision === 'cooperate' ? 'btn-success' : 'btn-danger');
        }

        async function acceptDeal() {
            const decision = document.getElementById('acceptDecision').value;

            if (!decision) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ!');
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É —Å —Ä–µ—à–µ–Ω–∏–µ–º –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ
            const { error: updateError } = await supabase
                .from('deals')
                .update({
                    to_player_id: currentPlayer.id,
                    to_decision: decision,
                    status: 'completed',
                    completed_at: new Date()
                })
                .eq('id', currentDealId);

            if (updateError) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–¥–µ–ª–∫–∏: ' + updateError.message);
                return;
            }

            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–¥–µ–ª–∫–∏
            const fromDecision = currentDeal.from_decision;
            const toDecision = decision;
            const amount = currentDeal.amount;

            let fromCoinsChange = 0;
            let toCoinsChange = 0;
            let fromReputationChange = 0;
            let toReputationChange = 0;

            // –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã "–≠–≤–æ–ª—é—Ü–∏—è –¥–æ–≤–µ—Ä–∏—è"
            if (fromDecision === 'cooperate' && toDecision === 'cooperate') {
                // –û–±–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—é—Ç - –æ–±–∞ –ø–æ–ª—É—á–∞—é—Ç –≤—ã–≥–æ–¥—É
                fromCoinsChange = amount;
                toCoinsChange = amount;
                fromReputationChange = 5;
                toReputationChange = 5;
            } else if (fromDecision === 'cooperate' && toDecision === 'cheat') {
                // –ü—Ä–µ–¥–ª–∞–≥–∞—é—â–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ—Ç, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π –æ–±–º–∞–Ω—ã–≤–∞–µ—Ç
                fromCoinsChange = -amount;
                toCoinsChange = amount * 2;
                fromReputationChange = 0;
                toReputationChange = -10;
            } else if (fromDecision === 'cheat' && toDecision === 'cooperate') {
                // –ü—Ä–µ–¥–ª–∞–≥–∞—é—â–∏–π –æ–±–º–∞–Ω—ã–≤–∞–µ—Ç, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ—Ç
                fromCoinsChange = amount * 2;
                toCoinsChange = -amount;
                fromReputationChange = -10;
                toReputationChange = 0;
            } else {
                // –û–±–∞ –æ–±–º–∞–Ω—ã–≤–∞—é—Ç - –æ–±–∞ —Ç–µ—Ä—è—é—Ç
                fromCoinsChange = -Math.floor(amount / 2);
                toCoinsChange = -Math.floor(amount / 2);
                fromReputationChange = -5;
                toReputationChange = -5;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–Ω–µ—Ç—ã –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—é –∏–≥—Ä–æ–∫–æ–≤
            await supabase
                .from('players')
                .update({
                    coins: currentPlayer.coins + toCoinsChange,
                    reputation: Math.max(0, currentPlayer.reputation + toReputationChange),
                    deals_completed: currentPlayer.deals_completed + 1,
                    deals_honored: currentPlayer.deals_honored + (toDecision === 'cooperate' ? 1 : 0)
                })
                .eq('id', currentPlayer.id);

            await supabase
                .from('players')
                .update({
                    coins: currentDeal.from_player.coins + fromCoinsChange,
                    reputation: Math.max(0, currentDeal.from_player.reputation + fromReputationChange),
                    deals_completed: currentDeal.from_player.deals_completed + 1,
                    deals_honored: currentDeal.from_player.deals_honored + (fromDecision === 'cooperate' ? 1 : 0)
                })
                .eq('id', currentDeal.from_player_id);

            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–¥–µ–ª–∫–∏
            await supabase
                .from('deal_history')
                .insert([{
                    deal_id: currentDealId,
                    player1_id: currentDeal.from_player_id,
                    player2_id: currentPlayer.id,
                    player1_decision: fromDecision,
                    player2_decision: toDecision,
                    player1_coins_change: fromCoinsChange,
                    player2_coins_change: toCoinsChange,
                    player1_reputation_change: fromReputationChange,
                    player2_reputation_change: toReputationChange
                }]);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            showDealResult(fromDecision, toDecision, fromCoinsChange, toCoinsChange, 
                          fromReputationChange, toReputationChange);

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            await updateCurrentPlayer();
            loadAvailableDeals();
            loadRanking();
            loadDealHistory();
        }

        async function updateCurrentPlayer() {
            const { data: player, error } = await supabase
                .from('players')
                .select('*')
                .eq('id', currentPlayer.id)
                .single();

            if (!error) {
                currentPlayer = player;
                updatePlayerInfo();
            }
        }

        function showDealResult(fromDecision, toDecision, fromCoinsChange, toCoinsChange, 
                               fromReputationChange, toReputationChange) {
            const resultContent = document.getElementById('dealResultContent');
            let resultHTML = '';

            if (fromDecision === 'cooperate' && toDecision === 'cooperate') {
                resultHTML = `
                    <div class="text-center">
                        <h4 class="text-success">ü§ù –í–∑–∞–∏–º–æ–≤—ã–≥–æ–¥–Ω–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ!</h4>
                        <p>–û–±–µ —Å—Ç–æ—Ä–æ–Ω—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–ª–∏ –∏ –ø–æ–ª—É—á–∏–ª–∏ –≤—ã–≥–æ–¥—É.</p>
                        <p>–í—ã –ø–æ–ª—É—á–∏–ª–∏: <strong class="text-success">+${toCoinsChange} –º–æ–Ω–µ—Ç</strong></p>
                        <p>–†–µ–ø—É—Ç–∞—Ü–∏—è: <strong class="text-success">+${toReputationChange}</strong></p>
                    </div>
                `;
            } else if (fromDecision === 'cooperate' && toDecision === 'cheat') {
                resultHTML = `
                    <div class="text-center">
                        <h4 class="text-warning">üéÅ –í—ã –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –¥–æ–≤–µ—Ä–∏–µ–º!</h4>
                        <p>–î—Ä—É–≥–æ–π –∏–≥—Ä–æ–∫ –¥–æ–≤–µ—Ä–∏–ª—Å—è –≤–∞–º, –Ω–æ –≤—ã –µ–≥–æ –æ–±–º–∞–Ω—É–ª–∏.</p>
                        <p>–í—ã –ø–æ–ª—É—á–∏–ª–∏: <strong class="text-success">+${toCoinsChange} –º–æ–Ω–µ—Ç</strong></p>
                        <p>–†–µ–ø—É—Ç–∞—Ü–∏—è: <strong class="text-danger">${toReputationChange}</strong></p>
                    </div>
                `;
            } else if (fromDecision === 'cheat' && toDecision === 'cooperate') {
                resultHTML = `
                    <div class="text-center">
                        <h4 class="text-danger">üíî –í–∞—Å –æ–±–º–∞–Ω—É–ª–∏!</h4>
                        <p>–í—ã –¥–æ–≤–µ—Ä–∏–ª–∏—Å—å, –Ω–æ –¥—Ä—É–≥–æ–π –∏–≥—Ä–æ–∫ –≤–∞—Å –æ–±–º–∞–Ω—É–ª.</p>
                        <p>–í—ã –ø–æ—Ç–µ—Ä—è–ª–∏: <strong class="text-danger">${toCoinsChange} –º–æ–Ω–µ—Ç</strong></p>
                        <p>–†–µ–ø—É—Ç–∞—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å</p>
                    </div>
                `;
            } else {
                resultHTML = `
                    <div class="text-center">
                        <h4 class="text-secondary">‚ö° –í–∑–∞–∏–º–Ω—ã–π –æ–±–º–∞–Ω!</h4>
                        <p>–û–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ–ø—ã—Ç–∞–ª–∏—Å—å –æ–±–º–∞–Ω—É—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞.</p>
                        <p>–í—ã –ø–æ—Ç–µ—Ä—è–ª–∏: <strong class="text-danger">${toCoinsChange} –º–æ–Ω–µ—Ç</strong></p>
                        <p>–†–µ–ø—É—Ç–∞—Ü–∏—è: <strong class="text-danger">${toReputationChange}</strong></p>
                    </div>
                `;
            }

            resultContent.innerHTML = resultHTML;
            bootstrap.Modal.getInstance(document.getElementById('acceptDealModal')).hide();
            new bootstrap.Modal(document.getElementById('dealResultModal')).show();
        }
    </script>
</body>
</html>