<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–≤–æ–ª—é—Ü–∏—è –î–æ–≤–µ—Ä–∏—è - –®–∫–æ–ª—å–Ω–∞—è –ò–≥—Ä–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .app-section {
            padding: 20px;
            display: none;
        }

        .active {
            display: block;
        }

        /* –§–æ—Ä–º—ã */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.success {
            background: #27ae60;
        }

        button.danger {
            background: #e74c3c;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .player-card {
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .player-info {
            flex: 1;
        }

        .player-stats {
            text-align: right;
        }

        /* –°–µ—Ç–∫–∏ */
        .grid {
            display: grid;
            gap: 15px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav {
            display: flex;
            background: #34495e;
            overflow-x: auto;
        }

        .nav button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            border-radius: 0;
            color: white;
            white-space: nowrap;
        }

        .nav button.active {
            background: #3498db;
        }

        /* –†–µ–ø—É—Ç–∞—Ü–∏—è */
        .reputation-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin: 5px 0;
            overflow: hidden;
        }

        .reputation-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .nav {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ –≠–≤–æ–ª—é—Ü–∏—è –î–æ–≤–µ—Ä–∏—è</h1>
            <p>–®–∫–æ–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞</p>
        </header>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="nav" id="nav" style="display: none;">
            <button onclick="showSection('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <button onclick="showSection('players')">üë• –ò–≥—Ä–æ–∫–∏</button>
            <button onclick="showSection('deals')">ü§ù –°–¥–µ–ª–∫–∏</button>
            <button onclick="showSection('rating')">üèÜ –†–µ–π—Ç–∏–Ω–≥</button>
            <button onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
        </nav>

        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <section id="auth-section" class="app-section active">
            <div style="max-width: 400px; margin: 40px auto; padding: 20px;">
                <h2 style="text-align: center; margin-bottom: 30px;">–í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h2>
                
                <div class="form-group">
                    <label>–ù–∏–∫–Ω–µ–π–º:</label>
                    <input type="text" id="username" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º">
                </div>
                
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <div class="form-group">
                    <label>–ö–ª–∞—Å—Å:</label>
                    <select id="class">
                        <option value="5–ê">5–ê</option>
                        <option value="5–ë">5–ë</option>
                        <option value="5–í">5–í</option>
                        <option value="5–ì">5–ì</option>
                        <option value="6–ê">6–ê</option>
                        <option value="6–ë">6–ë</option>
                        <option value="6–í">6–í</option>
                        <option value="6–ì">6–ì</option>
                        <option value="6–î">6–î</option>
                        <option value="7–ê">7–ê</option>
                        <option value="7–ë">7–ë</option>
                        <option value="8–ê">8–ê</option>
                        <option value="8–ë">8–ë</option>
                        <option value="8–í">8–í</option>
                        <option value="9–ê">9–ê</option>
                        <option value="9–ë">9–ë</option>
                        <option value="9–í">9–í</option>
                        <option value="10–ê">10–ê</option>
                        <option value="10–ë">10–ë</option>
                        <option value="11">11</option>
                    </select>
                </div>
                
                <button onclick="login()" style="margin-bottom: 15px;">–í–æ–π—Ç–∏</button>
                <button onclick="register()" class="secondary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </section>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <section id="profile-section" class="app-section">
            <h2>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="card">
                <div class="player-card">
                    <div class="player-info">
                        <h3 id="profile-username"></h3>
                        <p>–ö–ª–∞—Å—Å: <span id="profile-class"></span></p>
                        <p>–û—á–∫–∏: <span id="profile-score"></span></p>
                    </div>
                    <div class="player-stats">
                        <p>–†–µ–ø—É—Ç–∞—Ü–∏—è: <span id="profile-reputation"></span>/100</p>
                        <div class="reputation-bar">
                            <div class="reputation-fill" id="reputation-fill"></div>
                        </div>
                        <p>–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: <span id="profile-games"></span></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ -->
        <section id="players-section" class="app-section">
            <h2>–ò–≥—Ä–æ–∫–∏</h2>
            <div class="form-group">
                <input type="text" id="search-players" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫–Ω–µ–π–º—É..." oninput="searchPlayers()">
            </div>
            <select id="class-filter" onchange="loadPlayers()">
                <option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
                <!-- –û–ø—Ü–∏–∏ –∫–ª–∞—Å—Å–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </select>
            <div id="players-list"></div>
        </section>

        <!-- –°–¥–µ–ª–∫–∏ -->
        <section id="deals-section" class="app-section">
            <div class="grid grid-2">
                <div>
                    <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏</h2>
                    <div id="active-deals"></div>
                </div>
                <div>
                    <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h2>
                    <div id="deal-history"></div>
                </div>
            </div>
        </section>

        <!-- –†–µ–π—Ç–∏–Ω–≥ -->
        <section id="rating-section" class="app-section">
            <div class="grid grid-2">
                <div>
                    <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥ –ø–æ –æ—á–∫–∞–º</h2>
                    <div id="score-rating"></div>
                </div>
                <div>
                    <h2>‚≠ê –†–µ–π—Ç–∏–Ω–≥ –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏</h2>
                    <div id="reputation-rating"></div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        const supabaseUrl = 'https://isugrtihjmbrzwflybrr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzdWdydGloam1icnp3Zmx5YnJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODQ0OTQsImV4cCI6MjA3ODk2MDQ5NH0.ek79k1g5svlLdhbYS664Lkc-6_tKc06qUgR-MhZtGNI';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        // –§—É–Ω–∫—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const userClass = document.getElementById('class').value;

            if (!username || !password || !userClass) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            const { data, error } = await supabase
                .from('profiles')
                .insert([{ username, password, class: userClass }])
                .select();

            if (error) {
                alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
                return;
            }

            currentUser = data[0];
            startGame();
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('username', username)
                .eq('password', password);

            if (error || !data.length) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            currentUser = data[0];
            startGame();
        }

        function logout() {
            currentUser = null;
            showSection('auth-section');
            document.getElementById('nav').style.display = 'none';
        }

        function startGame() {
            showSection('profile');
            document.getElementById('nav').style.display = 'flex';
            updateProfile();
            loadPlayers();
            loadDeals();
            loadRating();
            setupRealtimeUpdates();
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function showSection(sectionName) {
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Ä–∞–∑–¥–µ–ª
            if (sectionName === 'profile') updateProfile();
            if (sectionName === 'players') loadPlayers();
            if (sectionName === 'deals') loadDeals();
            if (sectionName === 'rating') loadRating();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        async function updateProfile() {
            if (!currentUser) return;

            const { data } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (data) {
                currentUser = data;
                document.getElementById('profile-username').textContent = data.username;
                document.getElementById('profile-class').textContent = data.class;
                document.getElementById('profile-score').textContent = data.score;
                document.getElementById('profile-reputation').textContent = data.reputation;
                document.getElementById('profile-games').textContent = data.total_games;
                document.getElementById('reputation-fill').style.width = data.reputation + '%';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
        async function loadPlayers() {
            const search = document.getElementById('search-players').value;
            const classFilter = document.getElementById('class-filter').value;

            let query = supabase
                .from('profiles')
                .select('*')
                .neq('id', currentUser.id);

            if (search) {
                query = query.ilike('username', `%${search}%`);
            }

            if (classFilter) {
                query = query.eq('class', classFilter);
            }

            const { data: players } = await query;

            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'card fade-in';
                playerCard.innerHTML = `
                    <div class="player-card">
                        <div class="player-info">
                            <h4>${player.username}</h4>
                            <p>–ö–ª–∞—Å—Å: ${player.class}</p>
                            <p>–û—á–∫–∏: ${player.score}</p>
                        </div>
                        <div class="player-stats">
                            <p>–†–µ–ø—É—Ç–∞—Ü–∏—è: ${player.reputation}/100</p>
                            <div class="reputation-bar">
                                <div class="reputation-fill" style="width: ${player.reputation}%"></div>
                            </div>
                            <button onclick="proposeDeal('${player.id}')" class="success">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
                        </div>
                    </div>
                `;
                playersList.appendChild(playerCard);
            });
        }

        function searchPlayers() {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(loadPlayers, 300);
        }

        // –°–¥–µ–ª–∫–∏
        async function proposeDeal(player2Id) {
            const { error } = await supabase
                .from('deals')
                .insert([{ 
                    player1_id: currentUser.id, 
                    player2_id: player2Id 
                }]);

            if (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: ' + error.message);
            } else {
                alert('–°–¥–µ–ª–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∞!');
                loadDeals();
            }
        }

        async function loadDeals() {
            // –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ (–≥–¥–µ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫)
            const { data: activeDeals } = await supabase
                .from('deals')
                .select(`
                    *,
                    player1:profiles!player1_id(username, class),
                    player2:profiles!player2_id(username, class)
                `)
                .or(`player1_id.eq.${currentUser.id},player2_id.eq.${currentUser.id}`)
                .neq('status', 'completed')
                .order('created_at', { ascending: false });

            const activeDealsContainer = document.getElementById('active-deals');
            activeDealsContainer.innerHTML = '';

            if (activeDeals && activeDeals.length) {
                activeDeals.forEach(deal => {
                    const isPlayer1 = deal.player1_id === currentUser.id;
                    const opponent = isPlayer1 ? deal.player2 : deal.player1;
                    
                    const dealCard = document.createElement('div');
                    dealCard.className = 'card fade-in';
                    
                    let actions = '';
                    if (deal.status === 'pending' && !isPlayer1) {
                        actions = `
                            <button onclick="acceptDeal('${deal.id}')" class="success">–ü—Ä–∏–Ω—è—Ç—å</button>
                            <button onclick="declineDeal('${deal.id}')" class="danger">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        `;
                    } else if (deal.status === 'accepted') {
                        if (!deal[isPlayer1 ? 'player1_choice' : 'player2_choice']) {
                            actions = `
                                <button onclick="makeChoice('${deal.id}', 'cooperate')" class="success">–°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å</button>
                                <button onclick="makeChoice('${deal.id}', 'betray')" class="danger">–ü—Ä–µ–¥–∞—Ç—å</button>
                            `;
                        } else {
                            actions = '<p>–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞...</p>';
                        }
                    }

                    dealCard.innerHTML = `
                        <h4>–°–¥–µ–ª–∫–∞ —Å ${opponent.username} (${opponent.class})</h4>
                        <p>–°—Ç–∞—Ç—É—Å: ${getStatusText(deal.status)}</p>
                        ${actions}
                    `;
                    activeDealsContainer.appendChild(dealCard);
                });
            } else {
                activeDealsContainer.innerHTML = '<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</p>';
            }

            // –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫
            const { data: historyDeals } = await supabase
                .from('deals')
                .select(`
                    *,
                    player1:profiles!player1_id(username),
                    player2:profiles!player2_id(username)
                `)
                .or(`player1_id.eq.${currentUser.id},player2_id.eq.${currentUser.id}`)
                .eq('status', 'completed')
                .order('created_at', { ascending: false })
                .limit(10);

            const historyContainer = document.getElementById('deal-history');
            historyContainer.innerHTML = '';

            if (historyDeals && historyDeals.length) {
                historyDeals.forEach(deal => {
                    const isPlayer1 = deal.player1_id === currentUser.id;
                    const myChoice = isPlayer1 ? deal.player1_choice : deal.player2_choice;
                    const opponentChoice = isPlayer1 ? deal.player2_choice : deal.player1_choice;
                    const myScore = isPlayer1 ? deal.player1_score : deal.player2_score;
                    
                    const dealCard = document.createElement('div');
                    dealCard.className = 'card fade-in';
                    dealCard.innerHTML = `
                        <p><strong>${deal.player1.username} vs ${deal.player2.username}</strong></p>
                        <p>–í–∞—à —Ö–æ–¥: ${getChoiceText(myChoice)}</p>
                        <p>–•–æ–¥ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞: ${getChoiceText(opponentChoice)}</p>
                        <p>–í–∞—à–∏ –æ—á–∫–∏: ${myScore}</p>
                    `;
                    historyContainer.appendChild(dealCard);
                });
            } else {
                historyContainer.innerHTML = '<p>–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</p>';
            }
        }

        async function acceptDeal(dealId) {
            const { error } = await supabase
                .from('deals')
                .update({ status: 'accepted' })
                .eq('id', dealId);

            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } else {
                loadDeals();
            }
        }

        async function declineDeal(dealId) {
            const { error } = await supabase
                .from('deals')
                .delete()
                .eq('id', dealId);

            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } else {
                loadDeals();
            }
        }

        async function makeChoice(dealId, choice) {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–¥–µ–ª–∫—É
            const { data: deal } = await supabase
                .from('deals')
                .select('*')
                .eq('id', dealId)
                .single();

            const isPlayer1 = deal.player1_id === currentUser.id;
            const updateField = isPlayer1 ? 'player1_choice' : 'player2_choice';

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä
            const { error } = await supabase
                .from('deals')
                .update({ [updateField]: choice })
                .eq('id', dealId);

            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–¥–µ–ª–∞–ª–∏ –ª–∏ –æ–±–∞ —Ö–æ–¥–∞
            const { data: updatedDeal } = await supabase
                .from('deals')
                .select('*')
                .eq('id', dealId)
                .single();

            if (updatedDeal.player1_choice && updatedDeal.player2_choice) {
                // –û–±–∞ —Å–¥–µ–ª–∞–ª–∏ —Ö–æ–¥ - –≤—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                await calculateDealResults(dealId);
            }

            loadDeals();
            updateProfile();
        }

        async function calculateDealResults(dealId) {
            const { data: deal } = await supabase
                .from('deals')
                .select('*')
                .eq('id', dealId)
                .single();

            // –ü—Ä–∞–≤–∏–ª–∞ –¥–∏–ª–µ–º–º—ã –∑–∞–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ
            let player1Score, player2Score;

            if (deal.player1_choice === 'cooperate' && deal.player2_choice === 'cooperate') {
                player1Score = player2Score = 2; // –í–∑–∞–∏–º–Ω–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ
            } else if (deal.player1_choice === 'cooperate' && deal.player2_choice === 'betray') {
                player1Score = 0; // –í–∞—Å –æ–±–º–∞–Ω—É–ª–∏
                player2Score = 3; // –ò—Å–∫—É—à–µ–Ω–∏–µ –ø—Ä–µ–¥–∞—Ç—å
            } else if (deal.player1_choice === 'betray' && deal.player2_choice === 'cooperate') {
                player1Score = 3; // –ò—Å–∫—É—à–µ–Ω–∏–µ –ø—Ä–µ–¥–∞—Ç—å
                player2Score = 0; // –í–∞—Å –æ–±–º–∞–Ω—É–ª–∏
            } else {
                player1Score = player2Score = 1; // –í–∑–∞–∏–º–Ω–æ–µ –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏ –≤ —Å–¥–µ–ª–∫–µ
            await supabase
                .from('deals')
                .update({ 
                    player1_score: player1Score,
                    player2_score: player2Score,
                    status: 'completed'
                })
                .eq('id', dealId);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤
            await updatePlayerStats(deal.player1_id, player1Score, deal.player1_choice);
            await updatePlayerStats(deal.player2_id, player2Score, deal.player2_choice);
        }

        async function updatePlayerStats(playerId, score, choice) {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
            const { data: player } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', playerId)
                .single();

            const newScore = player.score + score;
            const newTotalGames = player.total_games + 1;
            const newCooperationCount = player.cooperation_count + (choice === 'cooperate' ? 1 : 0);
            const newReputation = Math.round((newCooperationCount / newTotalGames) * 100);

            await supabase
                .from('profiles')
                .update({
                    score: newScore,
                    total_games: newTotalGames,
                    cooperation_count: newCooperationCount,
                    reputation: newReputation
                })
                .eq('id', playerId);
        }

        // –†–µ–π—Ç–∏–Ω–≥
        async function loadRating() {
            // –†–µ–π—Ç–∏–Ω–≥ –ø–æ –æ—á–∫–∞–º
            const { data: scoreRating } = await supabase
                .from('profiles')
                .select('username, class, score, reputation')
                .order('score', { ascending: false })
                .limit(20);

            const scoreContainer = document.getElementById('score-rating');
            scoreContainer.innerHTML = '';

            if (scoreRating) {
                scoreRating.forEach((player, index) => {
                    const rankCard = document.createElement('div');
                    rankCard.className = 'card fade-in';
                    rankCard.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <div style="font-size: 24px; font-weight: bold; margin-right: 15px;">
                                ${index + 1}
                            </div>
                            <div style="flex: 1;">
                                <h4>${player.username}</h4>
                                <p>–ö–ª–∞—Å—Å: ${player.class}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="font-size: 18px; font-weight: bold;">${player.score} –æ—á–∫–æ–≤</p>
                                <p>–†–µ–ø—É—Ç–∞—Ü–∏—è: ${player.reputation}</p>
                            </div>
                        </div>
                    `;
                    scoreContainer.appendChild(rankCard);
                });
            }

            // –†–µ–π—Ç–∏–Ω–≥ –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
            const { data: reputationRating } = await supabase
                .from('profiles')
                .select('username, class, score, reputation')
                .order('reputation', { ascending: false })
                .limit(20);

            const reputationContainer = document.getElementById('reputation-rating');
            reputationContainer.innerHTML = '';

            if (reputationRating) {
                reputationRating.forEach((player, index) => {
                    const rankCard = document.createElement('div');
                    rankCard.className = 'card fade-in';
                    rankCard.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <div style="font-size: 24px; font-weight: bold; margin-right: 15px;">
                                ${index + 1}
                            </div>
                            <div style="flex: 1;">
                                <h4>${player.username}</h4>
                                <p>–ö–ª–∞—Å—Å: ${player.class}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="font-size: 18px; font-weight: bold;">${player.reputation}%</p>
                                <p>–û—á–∫–∏: ${player.score}</p>
                            </div>
                        </div>
                    `;
                    reputationContainer.appendChild(rankCard);
                });
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getStatusText(status) {
            const statusMap = {
                'pending': '–û–∂–∏–¥–∞–Ω–∏–µ',
                'accepted': '–ü—Ä–∏–Ω—è—Ç–∞',
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'
            };
            return statusMap[status] || status;
        }

        function getChoiceText(choice) {
            const choiceMap = {
                'cooperate': 'ü§ù –°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ',
                'betray': 'üòà –ü—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ'
            };
            return choiceMap[choice] || '–ù–µ —Å–¥–µ–ª–∞–Ω';
        }

        // Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function setupRealtimeUpdates() {
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–¥–µ–ª–∫–∞—Ö
            supabase
                .channel('deals')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'deals' },
                    () => {
                        if (document.getElementById('deals-section').classList.contains('active')) {
                            loadDeals();
                        }
                    }
                )
                .subscribe();

            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª—è—Ö
            supabase
                .channel('profiles')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'profiles' },
                    () => {
                        updateProfile();
                        if (document.getElementById('rating-section').classList.contains('active')) {
                            loadRating();
                        }
                    }
                )
                .subscribe();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –∫–ª–∞—Å—Å–æ–≤
        function initClassFilter() {
            const classes = ["5–ê", "5–ë", "5–í", "5–ì", "6–ê", "6–ë", "6–í", "6–ì", "6–î", "7–ê", "7–ë", "8–ê", "8–ë", "8–í", "9–ê", "9–ë", "9–í", "10–ê", "10–ë", "11"];
            const filter = document.getElementById('class-filter');
            
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                filter.appendChild(option);
            });
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initClassFilter();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                startGame();
            }
        });
    </script>
</body>
</html>