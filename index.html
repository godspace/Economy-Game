<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Математический капиталист</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid #f1c40f;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
        }

        .nav-btn {
            flex: 1;
            margin: 0 5px;
            padding: 10px;
            text-align: center;
            background: #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .nav-btn.active {
            background: #3498db;
            color: white;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #3498db;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 0 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .player-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-info {
            display: flex;
            flex-direction: column;
        }

        .player-name {
            font-weight: 600;
        }

        .player-class {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .player-stats {
            display: flex;
            gap: 10px;
        }

        .player-coins, .player-rep {
            font-weight: 600;
        }

        .investment-option {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .investment-option:hover {
            border-color: #3498db;
        }

        .investment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .investment-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .investment-risk {
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .risk-low {
            background: #d5f4e6;
            color: #27ae60;
        }

        .risk-high {
            background: #fadbd8;
            color: #e74c3c;
        }

        .investment-details {
            margin-bottom: 15px;
            color: #7f8c8d;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .leaderboard-table tr:hover {
            background: #f8f9fa;
        }

        .rank {
            font-weight: bold;
            width: 50px;
        }

        .rank-1 {
            color: #f1c40f;
        }

        .rank-2 {
            color: #95a5a6;
        }

        .rank-3 {
            color: #d35400;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-group button {
            flex: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #2ecc71;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #e74c3c;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            width: auto;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid #3498db;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .positive {
            color: #27ae60;
        }

        .negative {
            color: #e74c3c;
        }

        @media (max-width: 600px) {
            .stats {
                flex-direction: column;
            }
            
            .stat {
                margin: 5px 0;
            }
            
            .nav {
                flex-wrap: wrap;
            }
            
            .nav-btn {
                flex: 1 0 45%;
                margin: 5px;
            }
            
            .player-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .player-stats {
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Математический капиталист</h1>
            <div class="subtitle">Школьная экономическая игра</div>
        </header>
        
        <div class="content">
            <!-- Экран входа -->
            <div id="login-screen" class="screen active">
                <div class="card">
                    <h2>Вход в игру</h2>
                    <p style="margin-bottom: 20px;">Введите ваш никнейм, пароль и выберите класс</p>
                    
                    <div class="form-group">
                        <label for="username">Никнейм</label>
                        <input type="text" id="username" placeholder="Придумайте уникальный никнейм">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Пароль</label>
                        <input type="password" id="password" placeholder="Введите пароль">
                    </div>
                    
                    <div class="form-group">
                        <label for="class">Ваш класс</label>
                        <select id="class">
                            <option value="">Выберите класс</option>
                            <option value="5А">5А</option>
                            <option value="5Б">5Б</option>
                            <option value="5В">5В</option>
                            <option value="5Г">5Г</option>
                            <option value="6А">6А</option>
                            <option value="6Б">6Б</option>
                            <option value="6В">6В</option>
                            <option value="6Г">6Г</option>
                            <option value="6Д">6Д</option>
                            <option value="7А">7А</option>
                            <option value="7Б">7Б</option>
                            <option value="8А">8А</option>
                            <option value="8Б">8Б</option>
                            <option value="8В">8В</option>
                            <option value="9А">9А</option>
                            <option value="9Б">9Б</option>
                            <option value="9В">9В</option>
                            <option value="10А">10А</option>
                            <option value="10Б">10Б</option>
                            <option value="11">11</option>
                        </select>
                    </div>
                    
                    <button id="login-btn">Войти в игру</button>
                </div>
            </div>
            
            <!-- Основной экран игры -->
            <div id="game-screen" class="screen">
                <div class="nav">
                    <div class="nav-btn active" data-screen="profile">Профиль</div>
                    <div class="nav-btn" data-screen="trade">Торговля</div>
                    <div class="nav-btn" data-screen="bank">Банк</div>
                    <div class="nav-btn" data-screen="leaderboard">Рейтинги</div>
                    <div class="nav-btn" data-screen="history">История</div>
                </div>
                
                <!-- Профиль -->
                <div id="profile" class="screen-section active">
                    <div class="card">
                        <h2>Ваш профиль</h2>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value" id="user-coins">100</div>
                                <div class="stat-label">Монеты</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="user-reputation">50</div>
                                <div class="stat-label">Репутация</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="user-class">5А</div>
                                <div class="stat-label">Класс</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3>Статистика</h3>
                            <p>Успешных сделок: <span id="successful-deals">0</span></p>
                            <p>Активных вкладов: <span id="active-investments">0</span></p>
                            <p>Общий доход: <span id="total-income">0</span> монет</p>
                        </div>
                    </div>
                    
                    <button id="logout-btn" class="btn-secondary" style="margin-top: 20px;">Выйти</button>
                </div>
                
                <!-- Торговая площадка -->
                <div id="trade" class="screen-section">
                    <div class="card">
                        <h2>Торговая площадка</h2>
                        <p>Взаимодействуйте с другими игроками через механику "Эволюция доверия"</p>
                        
                        <div class="tabs">
                            <div class="tab active" data-tab="players">Игроки</div>
                            <div class="tab" data-tab="propose">Предложить сделку</div>
                        </div>
                        
                        <div id="players-tab" class="tab-content active">
                            <h3>Доступные игроки</h3>
                            <div class="player-list" id="players-list">
                                <!-- Список игроков будет здесь -->
                            </div>
                        </div>
                        
                        <div id="propose-tab" class="tab-content">
                            <h3>Предложить сделку</h3>
                            <div class="form-group">
                                <label for="deal-player">Выберите игрока</label>
                                <select id="deal-player">
                                    <!-- Опции будут заполнены JavaScript -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deal-amount">Сумма сделки</label>
                                <input type="number" id="deal-amount" min="1" max="100" value="10">
                            </div>
                            <button id="propose-deal-btn">Предложить сделку</button>
                        </div>
                    </div>
                </div>
                
                <!-- Банк -->
                <div id="bank" class="screen-section">
                    <div class="card">
                        <h2>Банковские услуги</h2>
                        <p>Увеличьте свой капитал с помощью банковских вкладов</p>
                        
                        <div class="investment-option">
                            <div class="investment-header">
                                <div class="investment-title">Надёжный вклад</div>
                                <div class="investment-risk risk-low">Низкий риск</div>
                            </div>
                            <div class="investment-details">
                                <p>Доходность: 5-10% за 24 часа</p>
                                <p>Риск: 0%</p>
                                <p>Лимит: 50% от капитала</p>
                            </div>
                            <div class="form-group">
                                <label for="safe-amount">Сумма вклада</label>
                                <input type="number" id="safe-amount" min="1" value="10">
                            </div>
                            <button id="safe-invest-btn" class="btn-success">Сделать вклад</button>
                        </div>
                        
                        <div class="investment-option">
                            <div class="investment-header">
                                <div class="investment-title">Рисковый вклад</div>
                                <div class="investment-risk risk-high">Высокий риск</div>
                            </div>
                            <div class="investment-details">
                                <p>Доходность: 50-100% за 24 часа</p>
                                <p>Риск: 30% вероятность потери</p>
                                <p>Лимит: 25% от капитала</p>
                            </div>
                            <div class="form-group">
                                <label for="risky-amount">Сумма вклада</label>
                                <input type="number" id="risky-amount" min="1" value="10">
                            </div>
                            <button id="risky-invest-btn" class="btn-secondary">Сделать вклад</button>
                        </div>
                    </div>
                </div>
                
                <!-- Рейтинги -->
                <div id="leaderboard" class="screen-section">
                    <div class="card">
                        <h2>Рейтинги игроков</h2>
                        
                        <div class="tabs">
                            <div class="tab active" data-tab="coins-leaderboard">По монетам</div>
                            <div class="tab" data-tab="reputation-leaderboard">По репутации</div>
                        </div>
                        
                        <div id="coins-leaderboard-tab" class="tab-content active">
                            <table class="leaderboard-table">
                                <thead>
                                    <tr>
                                        <th class="rank">#</th>
                                        <th>Игрок</th>
                                        <th>Класс</th>
                                        <th>Монеты</th>
                                    </tr>
                                </thead>
                                <tbody id="coins-leaderboard-body">
                                    <!-- Рейтинг по монетам будет здесь -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="reputation-leaderboard-tab" class="tab-content">
                            <table class="leaderboard-table">
                                <thead>
                                    <tr>
                                        <th class="rank">#</th>
                                        <th>Игрок</th>
                                        <th>Класс</th>
                                        <th>Репутация</th>
                                    </tr>
                                </thead>
                                <tbody id="reputation-leaderboard-body">
                                    <!-- Рейтинг по репутации будет здесь -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- История -->
                <div id="history" class="screen-section">
                    <div class="card">
                        <h2>История операций</h2>
                        
                        <div class="tabs">
                            <div class="tab active" data-tab="transactions-history">Сделки</div>
                            <div class="tab" data-tab="investments-history">Вклады</div>
                        </div>
                        
                        <div id="transactions-history-tab" class="tab-content active">
                            <div id="transactions-list">
                                <!-- История сделок будет здесь -->
                            </div>
                        </div>
                        
                        <div id="investments-history-tab" class="tab-content">
                            <div id="investments-list">
                                <!-- История вкладов будет здесь -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для сделки -->
    <div id="deal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Предложение сделки</h3>
                <span class="close">&times;</span>
            </div>
            <p>Игрок <span id="deal-player-name"></span> предлагает вам сделку на <span id="deal-amount-value"></span> монет.</p>
            <p>Вы можете сотрудничать или предать. Помните: ваше решение повлияет на репутацию!</p>
            <div class="btn-group">
                <button id="cooperate-btn" class="btn-success">Сотрудничать</button>
                <button id="betray-btn" class="btn-secondary">Предать</button>
            </div>
        </div>
    </div>
    
    <!-- Уведомление -->
    <div id="notification" class="notification"></div>
    
    <script>
        // Конфигурация Supabase
        const SUPABASE_URL = 'https://isugrtihjmbrzwflybrr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzdWdydGloam1icnp3Zmx5YnJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODQ0OTQsImV4cCI6MjA3ODk2MDQ5NH0.ek79k1g5svlLdhbYS664Lkc-6_tKc06qUgR-MhZtGNI';
        
        // Инициализация Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Глобальные переменные
        let currentUser = null;
        let players = [];
        let pendingDeal = null;
        
        // DOM элементы
        const loginScreen = document.getElementById('login-screen');
        const gameScreen = document.getElementById('game-screen');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const classSelect = document.getElementById('class');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const navBtns = document.querySelectorAll('.nav-btn');
        const screenSections = document.querySelectorAll('.screen-section');
        const userCoinsEl = document.getElementById('user-coins');
        const userReputationEl = document.getElementById('user-reputation');
        const userClassEl = document.getElementById('user-class');
        const playersList = document.getElementById('players-list');
        const dealPlayerSelect = document.getElementById('deal-player');
        const dealAmountInput = document.getElementById('deal-amount');
        const proposeDealBtn = document.getElementById('propose-deal-btn');
        const safeAmountInput = document.getElementById('safe-amount');
        const safeInvestBtn = document.getElementById('safe-invest-btn');
        const riskyAmountInput = document.getElementById('risky-amount');
        const riskyInvestBtn = document.getElementById('risky-invest-btn');
        const coinsLeaderboardBody = document.getElementById('coins-leaderboard-body');
        const reputationLeaderboardBody = document.getElementById('reputation-leaderboard-body');
        const dealModal = document.getElementById('deal-modal');
        const dealPlayerName = document.getElementById('deal-player-name');
        const dealAmountValue = document.getElementById('deal-amount-value');
        const cooperateBtn = document.getElementById('cooperate-btn');
        const betrayBtn = document.getElementById('betray-btn');
        const notification = document.getElementById('notification');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, есть ли сохраненный пользователь
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showGameScreen();
                loadUserData();
                loadPlayers();
                loadLeaderboards();
                loadHistory();
            }
            
            // Назначаем обработчики событий
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Навигация
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    showScreen(screen);
                    
                    // Обновляем активные кнопки навигации
                    navBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Табы
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Обновляем активные табы
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Показываем соответствующий контент
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId + '-tab') {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Торговля
            proposeDealBtn.addEventListener('click', proposeDeal);
            safeInvestBtn.addEventListener('click', () => makeInvestment('safe'));
            riskyInvestBtn.addEventListener('click', () => makeInvestment('risky'));
            
            // Модальное окно сделки
            document.querySelector('.close').addEventListener('click', () => {
                dealModal.style.display = 'none';
            });
            
            cooperateBtn.addEventListener('click', () => respondToDeal('cooperate'));
            betrayBtn.addEventListener('click', () => respondToDeal('betray'));
            
            // Обновляем лимиты вкладов при изменении суммы
            safeAmountInput.addEventListener('input', updateInvestmentLimits);
            riskyAmountInput.addEventListener('input', updateInvestmentLimits);
            dealAmountInput.addEventListener('input', updateDealLimit);
        });
        
        // Функции для работы с экранами
        function showLoginScreen() {
            loginScreen.classList.add('active');
            gameScreen.classList.remove('active');
        }
        
        function showGameScreen() {
            loginScreen.classList.remove('active');
            gameScreen.classList.add('active');
        }
        
        function showScreen(screenName) {
            screenSections.forEach(section => {
                section.classList.remove('active');
                if (section.id === screenName) {
                    section.classList.add('active');
                }
            });
        }
        
        // Обработка входа
        async function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            const userClass = classSelect.value;
            
            if (!username || !password || !userClass) {
                showNotification('Заполните все поля!', 'error');
                return;
            }
            
            try {
                // Проверяем, существует ли пользователь
                const { data: existingUser, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                if (existingUser) {
                    // Проверяем пароль
                    if (existingUser.password !== password) {
                        showNotification('Неверный пароль!', 'error');
                        return;
                    }
                    currentUser = existingUser;
                } else {
                    // Создаем нового пользователя
                    const newUser = {
                        username,
                        password,
                        class: userClass,
                        coins: 100,
                        reputation: 50
                    };
                    
                    const { data, error } = await supabase
                        .from('profiles')
                        .insert([newUser])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    currentUser = data;
                }
                
                // Сохраняем пользователя в localStorage
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Показываем игровой экран
                showGameScreen();
                showScreen('profile');
                
                // Загружаем данные
                loadUserData();
                loadPlayers();
                loadLeaderboards();
                loadHistory();
                
                showNotification('Успешный вход в игру!');
                
            } catch (error) {
                console.error('Ошибка входа:', error);
                showNotification('Ошибка входа. Попробуйте снова.', 'error');
            }
        }
        
        // Обработка выхода
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginScreen();
            usernameInput.value = '';
            passwordInput.value = '';
            classSelect.value = '';
        }
        
        // Загрузка данных пользователя
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                currentUser = data;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Обновляем UI
                userCoinsEl.textContent = currentUser.coins;
                userReputationEl.textContent = currentUser.reputation;
                userClassEl.textContent = currentUser.class;
                
                // Обновляем лимиты вкладов
                updateInvestmentLimits();
                updateDealLimit();
                
            } catch (error) {
                console.error('Ошибка загрузки данных пользователя:', error);
            }
        }
        
        // Загрузка списка игроков
        async function loadPlayers() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, username, class, coins, reputation')
                    .neq('id', currentUser.id)
                    .order('coins', { ascending: false });
                
                if (error) throw error;
                
                players = data;
                
                // Обновляем список игроков в UI
                playersList.innerHTML = '';
                dealPlayerSelect.innerHTML = '<option value="">Выберите игрока</option>';
                
                players.forEach(player => {
                    // Добавляем в список игроков
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-item';
                    playerItem.innerHTML = `
                        <div class="player-info">
                            <div class="player-name">${player.username}</div>
                            <div class="player-class">${player.class}</div>
                        </div>
                        <div class="player-stats">
                            <div class="player-coins">${player.coins} монет</div>
                            <div class="player-rep">${player.reputation} реп.</div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn propose-deal-btn" data-player-id="${player.id}">Сделка</button>
                        </div>
                    `;
                    playersList.appendChild(playerItem);
                    
                    // Добавляем в выпадающий список для предложения сделки
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.username} (${player.class}) - ${player.coins} монет`;
                    dealPlayerSelect.appendChild(option);
                });
                
                // Назначаем обработчики для кнопок предложения сделки
                document.querySelectorAll('.propose-deal-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const playerId = this.getAttribute('data-player-id');
                        const player = players.find(p => p.id === playerId);
                        if (player) {
                            dealPlayerSelect.value = playerId;
                            // Переключаемся на вкладку предложения сделки
                            document.querySelector('[data-tab="propose"]').click();
                        }
                    });
                });
                
            } catch (error) {
                console.error('Ошибка загрузки списка игроков:', error);
            }
        }
        
        // Загрузка рейтингов
        async function loadLeaderboards() {
            try {
                // Рейтинг по монетам
                const { data: coinsData, error: coinsError } = await supabase
                    .from('profiles')
                    .select('username, class, coins')
                    .order('coins', { ascending: false })
                    .limit(20);
                
                if (coinsError) throw coinsError;
                
                coinsLeaderboardBody.innerHTML = '';
                coinsData.forEach((player, index) => {
                    const row = document.createElement('tr');
                    const rankClass = index < 3 ? `rank-${index+1}` : '';
                    row.innerHTML = `
                        <td class="rank ${rankClass}">${index + 1}</td>
                        <td>${player.username}</td>
                        <td>${player.class}</td>
                        <td>${player.coins}</td>
                    `;
                    coinsLeaderboardBody.appendChild(row);
                });
                
                // Рейтинг по репутации
                const { data: reputationData, error: reputationError } = await supabase
                    .from('profiles')
                    .select('username, class, reputation')
                    .order('reputation', { ascending: false })
                    .limit(20);
                
                if (reputationError) throw reputationError;
                
                reputationLeaderboardBody.innerHTML = '';
                reputationData.forEach((player, index) => {
                    const row = document.createElement('tr');
                    const rankClass = index < 3 ? `rank-${index+1}` : '';
                    row.innerHTML = `
                        <td class="rank ${rankClass}">${index + 1}</td>
                        <td>${player.username}</td>
                        <td>${player.class}</td>
                        <td>${player.reputation}</td>
                    `;
                    reputationLeaderboardBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки рейтингов:', error);
            }
        }
        
        // Загрузка истории операций
        async function loadHistory() {
            if (!currentUser) return;
            
            try {
                // История сделок
                const { data: transactions, error: transactionsError } = await supabase
                    .from('transactions')
                    .select('*')
                    .or(`from_user_id.eq.${currentUser.id},to_user_id.eq.${currentUser.id}`)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (transactionsError) throw transactionsError;
                
                const transactionsList = document.getElementById('transactions-list');
                transactionsList.innerHTML = '';
                
                if (transactions.length === 0) {
                    transactionsList.innerHTML = '<p>У вас еще нет сделок.</p>';
                } else {
                    transactions.forEach(transaction => {
                        const isOutgoing = transaction.from_user_id === currentUser.id;
                        const otherUserId = isOutgoing ? transaction.to_user_id : transaction.from_user_id;
                        const otherUser = players.find(p => p.id === otherUserId) || { username: 'Неизвестный' };
                        
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        
                        let resultText = '';
                        let amountClass = '';
                        
                        if (transaction.type === 'trust_evolution') {
                            if (transaction.result === 'both_cooperate') {
                                resultText = 'Оба сотрудничали';
                                amountClass = 'positive';
                            } else if (transaction.result === 'both_betray') {
                                resultText = 'Оба предали';
                                amountClass = 'negative';
                            } else if (transaction.result === 'one_betrayed') {
                                if (isOutgoing && transaction.from_user_gain > 0) {
                                    resultText = 'Вы предали';
                                    amountClass = 'positive';
                                } else if (!isOutgoing && transaction.to_user_gain > 0) {
                                    resultText = 'Вас предали';
                                    amountClass = 'negative';
                                }
                            }
                        }
                        
                        item.innerHTML = `
                            <div>
                                <strong>${isOutgoing ? 'Вы → ' + otherUser.username : otherUser.username + ' → Вы'}</strong>
                                <div>${resultText}</div>
                                <small>${new Date(transaction.created_at).toLocaleString()}</small>
                            </div>
                            <div class="${amountClass}">
                                ${isOutgoing ? '-' : '+'}${transaction.amount} монет
                            </div>
                        `;
                        
                        transactionsList.appendChild(item);
                    });
                }
                
                // История вкладов
                const { data: investments, error: investmentsError } = await supabase
                    .from('investments')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (investmentsError) throw investmentsError;
                
                const investmentsList = document.getElementById('investments-list');
                investmentsList.innerHTML = '';
                
                if (investments.length === 0) {
                    investmentsList.innerHTML = '<p>У вас еще нет вкладов.</p>';
                } else {
                    investments.forEach(investment => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        
                        let statusText = '';
                        let amountClass = '';
                        
                        if (investment.status === 'active') {
                            statusText = 'Активный';
                        } else if (investment.status === 'completed') {
                            statusText = 'Завершен';
                            amountClass = 'positive';
                        } else if (investment.status === 'failed') {
                            statusText = 'Провален';
                            amountClass = 'negative';
                        }
                        
                        item.innerHTML = `
                            <div>
                                <strong>${investment.type === 'safe' ? 'Надёжный вклад' : 'Рисковый вклад'}</strong>
                                <div>${statusText}</div>
                                <small>${new Date(investment.created_at).toLocaleString()}</small>
                            </div>
                            <div>
                                <div>${investment.amount} монет</div>
                                <div class="${amountClass}">${investment.return_amount ? investment.return_amount + ' монет' : ''}</div>
                            </div>
                        `;
                        
                        investmentsList.appendChild(item);
                    });
                }
                
            } catch (error) {
                console.error('Ошибка загрузки истории:', error);
            }
        }
        
        // Предложение сделки
        async function proposeDeal() {
            const targetPlayerId = dealPlayerSelect.value;
            const amount = parseInt(dealAmountInput.value);
            
            if (!targetPlayerId || !amount || amount <= 0) {
                showNotification('Выберите игрока и укажите сумму!', 'error');
                return;
            }
            
            if (amount > currentUser.coins) {
                showNotification('Недостаточно монет!', 'error');
                return;
            }
            
            const targetPlayer = players.find(p => p.id === targetPlayerId);
            if (!targetPlayer) {
                showNotification('Игрок не найден!', 'error');
                return;
            }
            
            try {
                // Создаем запись о предложении сделки
                const deal = {
                    from_user_id: currentUser.id,
                    to_user_id: targetPlayerId,
                    amount: amount,
                    type: 'trust_evolution',
                    status: 'pending'
                };
                
                const { data, error } = await supabase
                    .from('transactions')
                    .insert([deal])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Уменьшаем монеты у текущего пользователя
                const newCoins = currentUser.coins - amount;
                await supabase
                    .from('profiles')
                    .update({ coins: newCoins })
                    .eq('id', currentUser.id);
                
                currentUser.coins = newCoins;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                userCoinsEl.textContent = newCoins;
                
                showNotification(`Предложение сделки отправлено игроку ${targetPlayer.username}!`);
                
                // Сбрасываем форму
                dealAmountInput.value = Math.min(10, Math.floor(newCoins / 2));
                
            } catch (error) {
                console.error('Ошибка предложения сделки:', error);
                showNotification('Ошибка предложения сделки. Попробуйте снова.', 'error');
            }
        }
        
        // Создание вклада
        async function makeInvestment(type) {
            const amountInput = type === 'safe' ? safeAmountInput : riskyAmountInput;
            const amount = parseInt(amountInput.value);
            
            if (!amount || amount <= 0) {
                showNotification('Укажите сумму вклада!', 'error');
                return;
            }
            
            if (amount > currentUser.coins) {
                showNotification('Недостаточно монет!', 'error');
                return;
            }
            
            // Проверяем лимиты
            const maxAmount = type === 'safe' 
                ? Math.floor(currentUser.coins * 0.5) 
                : Math.floor(currentUser.coins * 0.25);
                
            if (amount > maxAmount) {
                showNotification(`Максимальная сумма для этого вклада: ${maxAmount} монет`, 'error');
                return;
            }
            
            try {
                // Определяем параметры вклада
                let returnMultiplier, successRate;
                
                if (type === 'safe') {
                    returnMultiplier = 1 + (Math.random() * 0.05 + 0.05); // 5-10%
                    successRate = 1.0;
                } else {
                    returnMultiplier = 1 + (Math.random() * 0.5 + 0.5); // 50-100%
                    successRate = 0.7; // 70% успеха
                }
                
                // Создаем запись о вкладе
                const investment = {
                    user_id: currentUser.id,
                    type: type,
                    amount: amount,
                    return_multiplier: returnMultiplier,
                    success_rate: successRate,
                    status: 'active',
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('investments')
                    .insert([investment])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Уменьшаем монеты у текущего пользователя
                const newCoins = currentUser.coins - amount;
                await supabase
                    .from('profiles')
                    .update({ coins: newCoins })
                    .eq('id', currentUser.id);
                
                currentUser.coins = newCoins;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                userCoinsEl.textContent = newCoins;
                
                showNotification(`Вклад на ${amount} монет успешно создан!`);
                
                // Сбрасываем форму
                amountInput.value = Math.min(10, Math.floor(newCoins / (type === 'safe' ? 2 : 4)));
                updateInvestmentLimits();
                
                // Обновляем историю
                loadHistory();
                
            } catch (error) {
                console.error('Ошибка создания вклада:', error);
                showNotification('Ошибка создания вклада. Попробуйте снова.', 'error');
            }
        }
        
        // Обновление лимитов вкладов
        function updateInvestmentLimits() {
            if (!currentUser) return;
            
            const safeMax = Math.floor(currentUser.coins * 0.5);
            const riskyMax = Math.floor(currentUser.coins * 0.25);
            
            safeAmountInput.max = safeMax;
            riskyAmountInput.max = riskyMax;
            
            // Обновляем placeholder'ы
            safeAmountInput.placeholder = `Макс: ${safeMax}`;
            riskyAmountInput.placeholder = `Макс: ${riskyMax}`;
        }
        
        // Обновление лимита сделки
        function updateDealLimit() {
            if (!currentUser) return;
            
            const dealMax = Math.min(100, currentUser.coins);
            dealAmountInput.max = dealMax;
            dealAmountInput.placeholder = `Макс: ${dealMax}`;
        }
        
        // Ответ на предложение сделки
        async function respondToDeal(decision) {
            if (!pendingDeal) return;
            
            try {
                // Определяем результат сделки
                let result, fromUserGain, toUserGain, fromUserRepChange, toUserRepChange;
                
                // Для простоты, предполагаем, что другой игрок всегда сотрудничает
                // В реальном приложении здесь была бы сложная логика
                if (decision === 'cooperate') {
                    result = 'both_cooperate';
                    fromUserGain = pendingDeal.amount;
                    toUserGain = pendingDeal.amount;
                    fromUserRepChange = 5;
                    toUserRepChange = 5;
                } else {
                    result = 'one_betrayed';
                    fromUserGain = pendingDeal.amount * 3;
                    toUserGain = -pendingDeal.amount;
                    fromUserRepChange = -10;
                    toUserRepChange = 0;
                }
                
                // Обновляем сделку
                await supabase
                    .from('transactions')
                    .update({
                        status: 'completed',
                        result: result,
                        from_user_gain: fromUserGain,
                        to_user_gain: toUserGain
                    })
                    .eq('id', pendingDeal.id);
                
                // Обновляем балансы и репутацию
                const fromUserNewCoins = currentUser.coins + fromUserGain;
                const fromUserNewRep = Math.max(0, currentUser.reputation + fromUserRepChange);
                
                await supabase
                    .from('profiles')
                    .update({ 
                        coins: fromUserNewCoins,
                        reputation: fromUserNewRep
                    })
                    .eq('id', currentUser.id);
                
                currentUser.coins = fromUserNewCoins;
                currentUser.reputation = fromUserNewRep;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                userCoinsEl.textContent = fromUserNewCoins;
                userReputationEl.textContent = fromUserNewRep;
                
                // Обновляем другого игрока
                const toUserNewCoins = pendingDeal.from_user_coins + toUserGain;
                const toUserNewRep = Math.max(0, pendingDeal.from_user_reputation + toUserRepChange);
                
                await supabase
                    .from('profiles')
                    .update({ 
                        coins: toUserNewCoins,
                        reputation: toUserNewRep
                    })
                    .eq('id', pendingDeal.from_user_id);
                
                showNotification(`Сделка завершена! Вы ${decision === 'cooperate' ? 'сотрудничали' : 'предали'}.`);
                
                // Закрываем модальное окно
                dealModal.style.display = 'none';
                pendingDeal = null;
                
                // Обновляем данные
                loadUserData();
                loadPlayers();
                loadLeaderboards();
                loadHistory();
                
            } catch (error) {
                console.error('Ошибка обработки сделки:', error);
                showNotification('Ошибка обработки сделки. Попробуйте снова.', 'error');
            }
        }
        
        // Показать уведомление
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type === 'error' ? 'error' : 'success');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Симуляция получения предложения сделки (для демонстрации)
        // В реальном приложении это бы делалось через веб-сокеты или периодический опрос
        function simulateIncomingDeal() {
            if (players.length === 0 || Math.random() < 0.8) return;
            
            const randomPlayer = players[Math.floor(Math.random() * players.length)];
            const amount = Math.floor(Math.random() * 20) + 5;
            
            pendingDeal = {
                id: 'simulated-' + Date.now(),
                from_user_id: randomPlayer.id,
                from_user_name: randomPlayer.username,
                from_user_coins: randomPlayer.coins,
                from_user_reputation: randomPlayer.reputation,
                amount: amount
            };
            
            dealPlayerName.textContent = randomPlayer.username;
            dealAmountValue.textContent = amount;
            dealModal.style.display = 'flex';
        }
        
        // Периодическое обновление данных
        setInterval(() => {
            if (currentUser) {
                loadUserData();
                loadPlayers();
                loadLeaderboards();
                simulateIncomingDeal();
            }
        }, 10000); // Обновление каждые 10 секунд
    </script>
</body>
</html>