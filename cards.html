<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .upload-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px dashed #ddd;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: white;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .student-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .student-class {
            font-size: 16px;
            margin-bottom: 10px;
            color: #666;
        }

        .student-code {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #007bff;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 5px;
        }

        .qr-code {
            width: 120px;
            height: 120px;
            margin: 10px auto;
            display: block;
        }

        .controls {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .btn {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #218838;
        }

        .btn-print {
            background: #007bff;
        }

        .btn-print:hover {
            background: #0056b3;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
            }

            .upload-section,
            .tabs,
            .controls {
                display: none !important;
            }

            .tab-content {
                display: block !important;
                page-break-after: always;
            }

            .tab-content:last-child {
                page-break-after: auto;
            }

            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }

            .card {
                border: 1px solid #000;
                box-shadow: none;
            }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã –ö–∞—Ä—Ç–æ—á–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤</h1>
        
        <div class="upload-section">
            <input type="file" id="csvFile" accept=".csv" style="margin-bottom: 10px;">
            <button class="btn" onclick="loadCSV()">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV —Ñ–∞–π–ª</button>
            <p style="margin-top: 10px; color: #666; font-size: 14px;">
                –§–æ—Ä–º–∞—Ç CSV: class,last_name,first_name,code
            </p>
        </div>

        <div class="tabs" id="tabsContainer">
            <!-- –í–∫–ª–∞–¥–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
        </div>

        <div id="tabContentsContainer">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
        </div>

        <div class="controls">
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å PDF</button>
            <button class="btn" onclick="exportAllPDF()">üìÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –≤ PDF</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let studentsData = [];
        const QR_CODE_URL = 'https://raw.githubusercontent.com/godspace/Economy-Game/936b7b27738fe8571b60584f800243a67eafa835/qr.svg';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ CSV —Ñ–∞–π–ª–∞
        function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                parseCSV(csv);
            };
            reader.readAsText(file);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV
        function parseCSV(csv) {
            const lines = csv.split('\n');
            studentsData = [];

            for (let i = 1; i < lines.length; i++) { // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const line = lines[i].trim();
                if (line) {
                    const [class_, last_name, first_name, code] = line.split(',');
                    if (class_ && last_name && first_name && code) {
                        studentsData.push({
                            class: class_.trim(),
                            last_name: last_name.trim(),
                            first_name: first_name.trim(),
                            code: code.trim()
                        });
                    }
                }
            }

            if (studentsData.length > 0) {
                renderTabsAndCards();
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–∞—Ä—Ç–æ—á–µ–∫
        function renderTabsAndCards() {
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –∫–ª–∞—Å—Å–∞–º
            const classes = {};
            studentsData.forEach(student => {
                if (!classes[student.class]) {
                    classes[student.class] = [];
                }
                classes[student.class].push(student);
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å—ã
            const sortedClasses = Object.keys(classes).sort();

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            document.getElementById('tabsContainer').innerHTML = '';
            document.getElementById('tabContentsContainer').innerHTML = '';

            // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç
            sortedClasses.forEach((class_, index) => {
                // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–∫–ª–∞–¥–∫–∏
                const tabButton = document.createElement('button');
                tabButton.className = `tab ${index === 0 ? 'active' : ''}`;
                tabButton.textContent = `–ö–ª–∞—Å—Å ${class_}`;
                tabButton.onclick = () => switchTab(class_);
                document.getElementById('tabsContainer').appendChild(tabButton);

                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏
                const tabContent = document.createElement('div');
                tabContent.className = `tab-content ${index === 0 ? 'active' : ''}`;
                tabContent.id = `tab-${class_}`;

                const grid = document.createElement('div');
                grid.className = 'cards-grid';

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ —Ñ–∞–º–∏–ª–∏–∏
                const sortedStudents = classes[class_].sort((a, b) => 
                    a.last_name.localeCompare(b.last_name)
                );

                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
                sortedStudents.forEach(student => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="student-name">${student.last_name} ${student.first_name}</div>
                        <div class="student-class">–ö–ª–∞—Å—Å: ${student.class}</div>
                        <div class="student-code">–ö–æ–¥: ${student.code}</div>
                        <img src="${QR_CODE_URL}" alt="QR –∫–æ–¥" class="qr-code" 
                             onerror="this.src='https://via.placeholder.com/120x120?text=QR'">
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∏–≥—Ä—É
                        </div>
                    `;
                    grid.appendChild(card);
                });

                tabContent.appendChild(grid);
                document.getElementById('tabContentsContainer').appendChild(tabContent);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        function switchTab(className) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
            event.target.classList.add('active');
            document.getElementById(`tab-${className}`).classList.add('active');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –≤ –æ–¥–∏–Ω PDF
        async function exportAllPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const tabContents = document.querySelectorAll('.tab-content');
            
            for (let i = 0; i < tabContents.length; i++) {
                const tabContent = tabContents[i];
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏
                tabContent.style.display = 'block';
                
                const canvas = await html2canvas(tabContent, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                if (i > 0) {
                    pdf.addPage();
                }
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                const imgWidth = pdf.internal.pageSize.getWidth() - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
                if (i !== 0) {
                    tabContent.style.display = 'none';
                }
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                activeTab.style.display = 'block';
            }
            
            pdf.save('–∫–∞—Ä—Ç–æ—á–∫–∏_—É—á–µ–Ω–∏–∫–æ–≤.pdf');
        }

        // –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)
        const exampleCSV = `class,last_name,first_name,code
5–ê,–ê–Ω–∏—Å–∏–º–æ–≤–∞,–î–∞—Ä—å—è,123456
5–ê,–ë–µ—Ä–µ–∑–∏–Ω–∞,–î–∞—Ä—å—è,123457
5–ê,–ò–≤–∞–Ω–æ–≤,–ò–≤–∞–Ω,123458
5–ë,–ü–µ—Ç—Ä–æ–≤,–ü–µ—Ç—Ä,123459
5–ë,–°–∏–¥–æ—Ä–æ–≤–∞,–ê–Ω–Ω–∞,123460
6–ê,–ö–æ–∑–ª–æ–≤,–ê–ª–µ–∫—Å–µ–π,123461`;

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            parseCSV(exampleCSV);
        };
    </script>
</body>
</html>